Fix kernel cmdline no null terminal issue.

Meanwhile explicitly enlarge the cmdline size to 1023 bytes

Signed-off-by: Gang Wei <gang.wei@intel.com>

diff -r 5192fef95f6f -r 1a716b307948 tboot/common/linux.c
--- a/tboot/common/linux.c	Fri Dec 28 14:30:13 2012 +0800
+++ b/tboot/common/linux.c	Sat Jan 05 15:29:00 2013 +0800
@@ -103,7 +103,7 @@
     /* recommended layout
         0x0000 - 0x7FFF     Real mode kernel
         0x8000 - 0x8FFF     Stack and heap
-        0x9000 - 0x90FF     Kernel command line
+        0x9000 - 0x93FF     Kernel command line
         for details, see linux_defns.h
     */
 
@@ -124,12 +124,12 @@
     /* compare to the magic number */
     if ( hdr->header != HDRS_MAGIC ) {
         /* old kernel */
-        printk("Error: Old kernel (< 2.6.20) is not supported by tboot.\n");
+        printk("Error: Old kernel (< 2.6.22) is not supported by tboot.\n");
         return false;
     }
 
-    if ( hdr->version < 0x0205 ) {
-        printk("Error: Old kernel (<2.6.20) is not supported by tboot.\n");
+    if ( hdr->version < 0x0206 ) {
+        printk("Error: Old kernel (<2.6.22) is not supported by tboot.\n");
         return false;
     }
 
@@ -260,6 +260,7 @@
 
     /* set cmd_line_ptr */
     hdr->cmd_line_ptr = real_mode_base + KERNEL_CMDLINE_OFFSET;
+    hdr->cmdline_size = REAL_END_OFFSET - KERNEL_CMDLINE_OFFSET - 1;
 
     /* load protected-mode part */
     memmove((void *)protected_mode_base, linux_image + real_mode_size,
@@ -276,7 +277,8 @@
 
     /* copy cmdline */
     const char *kernel_cmdline = skip_filename((const char *)g_mbi->cmdline);
-    memcpy((void *)hdr->cmd_line_ptr, kernel_cmdline, strlen(kernel_cmdline));
+    strncpy((void *)hdr->cmd_line_ptr, kernel_cmdline, hdr->cmdline_size);
+    ((char *)hdr->cmd_line_ptr)[hdr->cmdline_size] = '\0';
 
     /* need to put boot_params in real mode area so it gets mapped */
     boot_params = (boot_params_t *)(real_mode_base + real_mode_size);
diff -r 5192fef95f6f -r 1a716b307948 tboot/include/linux_defns.h
--- a/tboot/include/linux_defns.h	Fri Dec 28 14:30:13 2012 +0800
+++ b/tboot/include/linux_defns.h	Sat Jan 05 15:29:00 2013 +0800
@@ -153,7 +153,7 @@
         |  I/O memory hole          |
 0A0000  +---------------------------+
         |  Reserved for BIOS        |  Do not use.  Reserved for BIOS EBDA.
-099100  +---------------------------+
+099400  +---------------------------+
         |  cmdline                  |
 099000  +---------------------------+
         |  Stack/heap               |  For use by the kernel real-mode code.
@@ -178,7 +178,7 @@
 #define REAL_KERNEL_OFFSET      0x0000
 #define BOOT_SECTOR_OFFSET      0x0200
 #define KERNEL_CMDLINE_OFFSET   0x9000
-#define REAL_END_OFFSET         0x9100
+#define REAL_END_OFFSET         0x9400
 
 #define REAL_MODE_SIZE          REAL_END_OFFSET - REAL_KERNEL_OFFSET
 
