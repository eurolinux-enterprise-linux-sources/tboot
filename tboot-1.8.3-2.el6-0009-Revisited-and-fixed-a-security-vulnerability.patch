From 0566322f61a3895da3fe333d8dcc8eada5ef4916 Mon Sep 17 00:00:00 2001
From: Ning Sun <ning.sun@intel.com>
Date: Mon, 24 Aug 2015 10:02:11 -0700
Subject: Revisited and fixed a security vulnerability

reported-by James Blake <blakej@ainfosec.com>.

For more info about it, please refer to
http://hg.code.sf.net/p/tboot/code/code?cmd=changeset;node=0efdaf7c5348

After this fix, tboot, for measurement purpose, will not remove the
module image name(including the filepath) from the module command line,
which is passed from boot loader to tboot.  Meanwhile, LCP tools
documentation were updated accordingly to address the change.

Reported-by: James Blake <blakej@ainfosec.com>
Signed-off-by: Ning Sun <ning.sun@intel.com>
---
 lcptools-v2/lcptools.txt |    4 ++++
 lcptools/lcptools2.txt   |    4 ++++
 tboot/common/policy.c    |    4 ++--
 tboot/common/tboot.c     |    3 ++-
 4 files changed, 12 insertions(+), 3 deletions(-)

diff --git a/lcptools-v2/lcptools.txt b/lcptools-v2/lcptools.txt
index 5693ade..cc7fd9c 100644
--- a/lcptools-v2/lcptools.txt
+++ b/lcptools-v2/lcptools.txt
@@ -15,6 +15,10 @@ Create an MLE element:
 2.  lcp2_crtpolelt --create --type mle --ctrl 0x00 --minver 17 --alg sha1
     --out mle.elt mle_hash
 
+Note: Since GRUB2 does not pass the file name in the command line field of the
+multiboot entry, the command line to be included in creation of MLE element
+should exclude the first file name in the command line field of multiboot entry.
+
 Create an SBIOS element:
 -----------------------
 1.  Create hash file containing BIOS hash(es), e.g. named sbios_hash
diff --git a/lcptools/lcptools2.txt b/lcptools/lcptools2.txt
index 8f3264c..d7787f5 100644
--- a/lcptools/lcptools2.txt
+++ b/lcptools/lcptools2.txt
@@ -15,6 +15,10 @@ Create an MLE element:
 2.  lcp_crtpolelt --create --type mle --ctrl 0x00 --minver 17 --out mle.elt
     mle_hash
 
+Note: Since GRUB2 does not pass the file name in the command line field of the 
+multiboot entry, the command line to be included in creation of MLE element 
+should exclude the first file name in the command line field of multiboot entry.
+
 Create a PCONF element:
 ----------------------
 1.  cat /sys/devices/platform/tpm_tis/pcrs |grep -e PCR-00 -e PCR-01 > pcrs
diff --git a/tboot/common/policy.c b/tboot/common/policy.c
index faed9e5..697a54e 100644
--- a/tboot/common/policy.c
+++ b/tboot/common/policy.c
@@ -424,8 +424,8 @@ static bool hash_module(hash_list_t *hl,
     /* hash command line */
     if ( cmdline == NULL )
         cmdline = "";
-    else
-        cmdline = skip_filename(cmdline);
+    // else
+    //    cmdline = skip_filename(cmdline);
 
     switch (g_tpm->extpol) {
     case TB_EXTPOL_FIXED: 
diff --git a/tboot/common/tboot.c b/tboot/common/tboot.c
index e49d2da..08c5e8a 100644
--- a/tboot/common/tboot.c
+++ b/tboot/common/tboot.c
@@ -341,7 +341,8 @@ void begin_launch(void *addr, uint32_t magic)
         const char *cmdline_orig = get_cmdline(g_ldr_ctx);
         const char *cmdline = NULL;
         if (cmdline_orig){
-            cmdline = skip_filename(cmdline_orig);
+           // cmdline = skip_filename(cmdline_orig);
+            cmdline = cmdline_orig;
         }
         memset(g_cmdline, '\0', sizeof(g_cmdline));
         if (cmdline)
-- 
1.7.1

